name: create_user
on:
  push:
    branches:
    - main
    paths:
      - 'roles/add_user/files/users/**/id_rsa.pub'
  workflow_dispatch:
    inputs:
      userName:
        required: true
        type: string
      
permissions: 
      id-token: write
      pull-requests: write
      
jobs:
  createUser:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 2

      - name: Zip entire repository
        run: zip -r ${{ github.sha }}.zip ./ -x "*.git*"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ap-northeast-1
          role-to-assume: arn:aws:iam::166313796795:role/test-gha

      - name: Put S3
        run: |
          export REPOSITORY=$(echo ${{ github.repository }} | sed -e "s#.*/##")
          aws s3 cp ${{ github.sha }}.zip s3://miyashita-ansible/$REPOSITORY/${{ github.ref_name }}/
          
      - name: Get username from input.
        if:  github.event_name == 'workflow_dispatch'
        env:
          USER: ${{ github.event.inputs.userName }}
        run: echo "USER=$USER" >> $GITHUB_ENV
      
      - name: Get username from push.
        if:  github.event_name == 'push'
        run: |
          USER=$(git diff ${{ github.event.before }}...${{ github.event.after }} --diff-filter=A --name-onlyh | cut -d'/' -f 5)
          echo "USER=$USER" >> $GITHUB_ENV
      
      - name: Create user with ansible via ssm.
        run: |            
          aws ssm send-command \
          --document-name "AWS-ApplyAnsiblePlaybooks" \
          --document-version "1" \
          --targets '[{"Key":"InstanceIds","Values":["i-050e7f95b5e8ecf89"]}]' \
          --parameters '{"SourceType":["S3"],"SourceInfo":["{\"path\": \"https://miyashita-ansible.s3.ap-northeast-1.amazonaws.com/ansible/main/${{ github.sha }}.zip\"}"],"InstallDependencies":["True"],"PlaybookFile":["playbooks/add_user.yml"],"ExtraVariables":["username='$USER'"],"Check":["False"],"Verbose":["-v"],"TimeoutSeconds":["3600"]}' \
          --timeout-seconds 600 \
          --max-concurrency "50" \
          --max-errors "0" \
          --region ap-northeast-1

      
